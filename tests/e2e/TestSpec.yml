version: 0.1

phases:
  install:
    commands:
      - export NVM_DIR=$HOME/.nvm
      - . $NVM_DIR/nvm.sh
      - nvm install 16.15.1

      # Fetch latest code from GitHub
      - git clone https://github.com/AndrewGable/App.git Git-App
      - cd $DEVICEFARM_TEST_PACKAGE_PATH/Git-App
      - git checkout andrew-aws-df
      - npm install

      # Move compiled APK to correct location
      - mkdir -p android/app/build/outputs/apk/e2eRelease/
      - cp ../app-e2eRelease.apk android/app/build/outputs/apk/e2eRelease/

      # Reverse ports using AWS magic
      - PORT=4723
      - IP_ADDRESS=$(ip -4 addr show eth0 | grep -Po "(?<=inet\s)\d+(\.\d+){3}")
      - reverse_values="{\"ip_address\":\"$IP_ADDRESS\",\"local_port\":\"$PORT\",\"remote_port\":\"$PORT\"}"
      - "curl -H \"Content-Type: application/json\" -X POST -d \"$reverse_values\" http://localhost:31007/reverse_forward_tcp"
      - adb reverse tcp:$PORT tcp:$PORT

  test:
    commands:
      - echo "Starting tests"
      - npm run test:e2e -- --skipInstallDeps --skipBuild

# The artifacts phase lets you specify the location where your tests logs, device logs will be stored.
# And also let you specify the location of your test logs and artifacts which you want to be collected by Device Farm.
# These logs and artifacts will be available through ListArtifacts API in Device Farm.
artifacts:
- $DEVICEFARM_LOG_DIR
- $DEVICEFARM_TEST_PACKAGE_PATH/Git-App/e2e
